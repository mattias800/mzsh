#!/usr/bin/env bash
set -euo pipefail

# mzsh: install recommended dependencies on macOS via Homebrew
# Safe to re-run; will skip already installed packages.

if ! command -v brew >/dev/null 2>&1; then
  echo "Homebrew not found. Please install Homebrew first: https://brew.sh" >&2
  exit 1
fi

# Formulae to install via Homebrew
pkgs=(
  git
  zsh-autosuggestions
  zsh-syntax-highlighting
  fzf
  bat
  eza
  yazi
  atuin
  z
  git-delta
  htop
  pstree
  jq
  ffmpeg
  sevenzip
  poppler
  fd
  ripgrep
  zoxide
  resvg
  imagemagick
  gping
  bun
)

# Install packages if missing
for pkg in "${pkgs[@]}"; do
  if brew list --formula --versions "$pkg" >/dev/null 2>&1; then
    echo "[mzsh] $pkg already installed"
  else
    echo "[mzsh] Installing $pkg"
    brew install "$pkg"
  fi
done

# Ensure zcomet (plugin manager) is installed or updated
ZCOMET_HOME="${ZCOMET_HOME:-$HOME/.zcomet}"
if [ -d "$ZCOMET_HOME/.git" ]; then
  echo "[mzsh] Updating zcomet in $ZCOMET_HOME"
  git -C "$ZCOMET_HOME" fetch --prune --quiet || true
  git -C "$ZCOMET_HOME" pull --ff-only || true
elif [ -d "$ZCOMET_HOME" ] && [ -f "$ZCOMET_HOME/zcomet.zsh" ]; then
  echo "[mzsh] zcomet found at $ZCOMET_HOME"
else
  echo "[mzsh] Installing zcomet to $ZCOMET_HOME"
  rm -rf "$ZCOMET_HOME" 2>/dev/null || true
  mkdir -p "$ZCOMET_HOME"
  git clone --depth=1 https://github.com/agkozak/zcomet "$ZCOMET_HOME"
fi

# Install zsh-interactive-cd into vendor path (no OMZ required)
VENDOR_DIR="$HOME/.local/share/zsh-interactive-cd"
if [ -d "$VENDOR_DIR/.git" ]; then
  echo "[mzsh] zsh-interactive-cd already installed at $VENDOR_DIR"
else
  echo "[mzsh] Installing zsh-interactive-cd plugin into $VENDOR_DIR"
  mkdir -p "$HOME/.local/share"
  git clone --depth=1 https://github.com/changyuheng/zsh-interactive-cd "$VENDOR_DIR"
fi

echo "[mzsh] Done. If needed, restart your terminal."
