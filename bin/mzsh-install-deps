#!/usr/bin/env bash
set -euo pipefail

# mzsh: install recommended dependencies on macOS via Homebrew
# Safe to re-run; will skip already installed packages.

# Ensure Homebrew exists and is on PATH (install if missing)
ensure_brew() {
  if command -v brew >/dev/null 2>&1; then
    return 0
  fi
  echo "[mzsh] Homebrew not found; installing (non-interactive)"
  NONINTERACTIVE=1 /bin/bash -c "$(/usr/bin/curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Detect brew binary path (Apple Silicon vs Intel)
  local brew_bin=""
  if [ -x /opt/homebrew/bin/brew ]; then
    brew_bin=/opt/homebrew/bin/brew
  elif [ -x /usr/local/bin/brew ]; then
    brew_bin=/usr/local/bin/brew
  else
    brew_bin="$(command -v brew || true)"
  fi
  if [ -z "${brew_bin}" ]; then
    echo "[mzsh] ERROR: Homebrew installation appears to have failed (brew not found on PATH)." >&2
    exit 1
  fi

  # shellenv for current session
  eval "$(${brew_bin} shellenv)"

  # Persist shellenv in ~/.zprofile if not already present
  local ZPROFILE="$HOME/.zprofile"
  local SHELLENV_LINE="eval \"\$(${brew_bin} shellenv)\""
  if [ ! -f "$ZPROFILE" ] || ! grep -Fq "$SHELLENV_LINE" "$ZPROFILE"; then
    echo "[mzsh] Appending Homebrew shellenv to ~/.zprofile"
    printf "\n%s\n" "$SHELLENV_LINE" >> "$ZPROFILE"
  fi
}

ensure_brew

# Use Brewfile for dependency management
REPO_DIR="${MZSH_DIR:-$HOME/.mzsh}"
BREWFILE="$REPO_DIR/Brewfile"
if [ ! -f "$BREWFILE" ]; then
  echo "[mzsh] ERROR: Brewfile not found at $BREWFILE" >&2
  exit 1
fi

echo "[mzsh] Installing/updating packages from $BREWFILE"
brew bundle --no-lock --file "$BREWFILE"

# Install zsh-interactive-cd into vendor path (no OMZ required)
VENDOR_DIR="$HOME/.local/share/zsh-interactive-cd"
if [ -d "$VENDOR_DIR/.git" ]; then
  echo "[mzsh] zsh-interactive-cd already installed at $VENDOR_DIR"
else
  echo "[mzsh] Installing zsh-interactive-cd plugin into $VENDOR_DIR"
  mkdir -p "$HOME/.local/share"
  git clone --depth=1 https://github.com/changyuheng/zsh-interactive-cd "$VENDOR_DIR"
fi

echo "[mzsh] Done. If needed, restart your terminal."
