#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail

VERSION="0.1.0"

_require_exec() {
  command -v "$1" >/dev/null 2>&1 || {
    printf 'mzsh: required helper not found in PATH: %s\n' "$1" >&2
    exit 127
  }
}

cmd="${1:-}"
case "$cmd" in
  update)
    shift
    _require_exec mzsh-update
    exec mzsh-update "$@"
    ;;
  install-deps)
    shift
    _require_exec mzsh-install-deps
    exec mzsh-install-deps "$@"
    ;;
  secrets)
    shift
    _require_exec mzsh-secrets
    exec mzsh-secrets "$@"
    ;;
  ssh)
    shift
    _require_exec mzsh-ssh
    exec mzsh-ssh "$@"
    ;;
  electron-headless-fix-apply)
    shift
    _require_exec electron-headless-fix-apply
    exec electron-headless-fix-apply "$@"
    ;;
  electron-headless-fix-undo)
    shift
    _require_exec electron-headless-fix-undo
    exec electron-headless-fix-undo "$@"
    ;;
  -v|--version)
    printf 'mzsh %s\n' "$VERSION"
    ;;
  help|-h|--help|'')
    cat <<'EOF'
Usage: mzsh <command> [args]

Commands:
  update                                        # update mzsh and dependencies
  install-deps                                  # install/update dependencies from Brewfile
  
  secrets pull [--manifest PATH] [--provider PROVIDER] [--dry-run]
  secrets sample [--manifest PATH]
  secrets install [op|bw|lpass|all]            # install required CLI(s) via Homebrew
  secrets doctor                                # check setup and provide guidance
  
  ssh [args]                                    # SSH command wrapper
  
  electron-headless-fix-apply                   # apply Electron CHROME_HEADLESS=1 workaround
  electron-headless-fix-undo                    # remove Electron workaround

Examples:
  mzsh update
  mzsh secrets sample                           # write example manifest if missing
  mzsh secrets pull                             # pull using default manifest
  mzsh secrets pull --manifest ~/.config/mzsh/secrets.json
  mzsh secrets pull --provider op               # force provider for all entries
  mzsh electron-headless-fix-apply              # fix macOS Electron slowdown

Secrets providers supported:
  op        1Password CLI (op)
  bw        Bitwarden CLI (bw)
  lpass     LastPass CLI (lpass)
  keychain  macOS Keychain (security)

The pull command reads a manifest describing which secrets to fetch and
writes them into ~/.mzsh/local.zsh between managed markers.
EOF
    ;;
  *)
    printf "mzsh: unknown command: %s (try 'mzsh --help')\n" "$cmd" >&2
    exit 2
    ;;
esac
